pr:
  branches:
    include:
      - master

variables:
  - group: OlasInternational_RN # Cambia esto al nombre que hayas configurado

pool:
  vmImage: 'ubuntu-latest'

steps:
  - checkout: self
    persistCredentials: true
    clean: true
  - task: NodeTool@0
    displayName: 'Install Node'
    inputs:
      versionSpec: '20.x' # or specify '20.18.0'
  - script: corepack enable
    displayName: Corepack enable for yarn versions
  - script: yarn install
    displayName: Install Dependencies
  - script: |
      # Deshabilitar autocommit en el aumento de versión 
      yarn config set version-sign-git-tag false
      yarn config set version-git-tag false
      yarn config set version-commit-hooks false
      # Extraer la versión existente de package.json
      oldVer=$(jq -r ".version" package.json)
      # Aumentar versión
      yarn version --patch
      # Añadir versión aumentada a staging
      git add *
      # Extraer nueva versión de package.json
      newVer=$(jq -r ".version" package.json)
      # Establecer variables de entorno
      echo "##vso[task.setvariable variable=OLD_VERSION]$oldVer"
      echo "##vso[task.setvariable variable=NEW_VERSION]$newVer"
    displayName: 'Bump version and set variables'

  # Construcción del APK
  - task: Gradle@2
    displayName: 'Build APK'
    inputs:
      gradleWrapperFile: 'android/gradlew'
      workingDirectory: 'android/'
      options: '-PversionName=$(NEW_VERSION) -PversionCode=$(Build.BuildId)'
      tasks: 'assembleRelease'
      publishJUnitResults: false
      javaHomeOption: 'JDKVersion'
      jdkVersionOption: '17'
      gradleOptions: '-Xmx3072m'
      sonarQubeRunAnalysis: false

  # Firmar APK
  - task: AndroidSigning@3
    displayName: 'Sign APK'
    inputs:
      apkFiles: 'android/app/build/outputs/apk/release/*.apk'
      apksignerKeystoreFile: 'mobile-prod.keystore'
      apksignerKeystorePassword: '$(AndroidKeyStorePassword)'
      apksignerKeystoreAlias: '$(AndroidKeyAlias)'
      apksignerKeyPassword: '$(AndroidKeyAliasPassword)'
      zipalign: true

  # Publicar APK como artefacto
  - task: PublishBuildArtifacts@1
    displayName: 'Publish APK to artifacts'
    inputs:
      PathtoPublish: 'android/app/build/outputs/apk/release'
      ArtifactName: 'android'
      publishLocation: 'Container'

  # Commits y tags
  #- script: |
  #    tag="android_$(NEW_VERSION)"
  #    echo "New tag $tag"
  #    git add *
  #    git commit -m "Update version from $(OLD_VERSION) to $(NEW_VERSION)"
  #    git tag $tag
  #    git pull --rebase origin $(Build.SourceBranchName)
  #    git push origin $(Build.SourceBranchName)
  #    git push --tags
  #  displayName: Bump commit
